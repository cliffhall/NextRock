"use strict";Macro.add("location",{tags:null,handler:function(){if(!State.getVar("$currentScene")&&!State.getVar("$endingBranchShown")){var t=document.createElement("div");t.setAttribute("id","locationContainer"),$(this.output).append(t),$(t).empty(),$(t).wiki(String(this.payload[0].contents).trim())}}}),setup.renderCurrentNav=function(){var t=State.getVar("$currentNav");if(t&&!State.getVar("$currentScene")){var n=$(State.getVar("$navContainer"));n.empty(),$(n).show(),t.sections.forEach(function(t){var e=$(document.createElement("div"));e.addClass("section"),e.append(t.name),e.appendTo(n);var a=$(document.createElement("div"));a.addClass("navlinks"),a.appendTo(n),t.actions.forEach(function(t,e){var n=document.createElement("span");n.setAttribute("id","action-".concat(e)),$(n).wiki(t).appendTo(a),0===$(n).text().trim().length&&$(n).remove()})})}},setup.navigate=function(){State.setVar("$currentNav",void 0),State.setVar("$endingBranchShown",!1)},Macro.add("nav",{tags:null,handler:function(){State.setVar("$currentNav",{sections:[]});var t=document.createElement("div");t.setAttribute("id","navContainer"),$(t).addClass("nav"),$(t).hide(),State.setVar("$navContainer",t),$(this.output).append(t),$.wiki(this.payload[0].contents),setup.renderCurrentNav()}}),Macro.add("section",{tags:["action"],handler:function(){if(this.args.length<1||"string"!=typeof this.args[0]||!this.args[0].trim())return this.error("You must name each section");var t={name:this.args[0].trim(),actions:[]};State.getVar("$currentNav").sections.push(t),t.actions=this.payload.splice(1).map(function(t){var e,n,a,r,c;return"action"===t.name&&(a=String(t.args[0]).trim(),c=String(t.contents).trim()||a,n=a.includes("<<")&&a.includes(">>")?'<<link "'.concat(c,'">>').concat(a,"<</link>>"):'<<link "'.concat(c,'" "').concat(a,'">><<run setup.navigate()>><</link>>'),e=(r=t.args[1])?function(t,e){return'<<capture _filter>>                            <<run jQuery.wiki("<<set _filter = !!( '.concat(e,' )>>")>>                            <<if _filter>>').concat(t,"<</if>>                       <</capture>>                ")}(n,r):n),e})}}),Macro.add("plot",{tags:["point"],handler:function(){var t={next:0},e=[];Array.isArray(State.getVar("$plots"))?e=State.getVar("$plots"):State.setVar("$plots",e),t.points=this.payload.splice(1).map(function(t){var e,n,a,r,c={};return"point"===t.name&&(n=String(t.args[0]).trim(),e='<<include "'.concat(n,'">>'),a=t.args[1],r=t.args[2],c.include=e,a&&!r?c.condition="<<if ".concat(a,">><<set $selectPoint to true>><</if>>"):a&&r?c.condition="<<if ".concat(a,">><<set $selectPoint to true>><<elseif ").concat(r,">><<set $discardPoint to true>><<set $selectPoint to false>><</if>>"):!a&&r&&(c.condition="<<if ".concat(r,">><<set $discardPoint to true>><<set $selectPoint to false>><</if>>")),console.log(c.condition)),c}),e.push(t),State.setVar("$plots",e)}}),Macro.add("narrator",{tags:null,handler:function(){if(!State.getVar("$currentScene")){State.setVar("$selectPoint",!1),State.setVar("$discardPoint",!1);var t=State.getVar("$plots");if(t){var e,n=0;do{if((e=t[n]).next!==e.points.length){var a=e.points[e.next];if(!a.condition){e.next++,$(this.output).wiki(a.include);break}$.wiki(a.condition);var r=State.getVar("$selectPoint"),c=State.getVar("$discardPoint");if(r){State.setVar("$selectPoint",!1),e.next++,$(this.output).wiki(a.include);break}c&&e.next++,n++}else n++}while(t[n])}}}}),setup.sceneBranchTaken=function(t,e){$(document).trigger({type:":scene-branch-taken",scene:t,branch:e})},setup.renderCurrentBranch=function(){var t=State.getVar("$currentScene");if(t&&t.branch&&t.branches){var e=t.branches[t.branch],n=e[0],a=e.slice(1),r=$(State.getVar("$sceneContainer"));if(r.empty(),r.wiki(n),a.length){var c=$(document.createElement("ul"));c.appendTo(r),a.forEach(function(t,e){var n=document.createElement("li");n.setAttribute("id","action-".concat(e)),$(n).wiki(t).appendTo(c),0===$(n).text().trim().length&&$(n).remove()})}else State.setVar("$endingBranchShown",!0),setup.markCurrentSceneComplete()}},setup.markCurrentSceneComplete=function(){var t=State.getVar("$currentScene");t&&(State.getVar("$completedScenes").push(t.name),State.setVar("$currentScene",null),State.getVar("$currentNav")&&setup.renderCurrentNav())},setup.hasSceneBeenCompleted=function(t){var e=!1,n=State.getVar("$completedScenes");return Array.isArray(n)?n.includes(t)&&(e=!0):(n=[],State.setVar("$completedScenes",n)),e},Macro.add("scene",{tags:null,handler:function(){if(this.args.length<1||"string"!=typeof this.args[0]||!this.args[0].trim())return this.error("You must name each scene");var t=this.args[0].trim();if(!setup.hasSceneBeenCompleted(t)){State.setVar("$currentScene",{name:t,branch:null,branches:{}});var e=document.createElement("div");e.setAttribute("id","sceneContainer"),State.setVar("$sceneContainer",e),$(this.output).append(e),$.wiki(this.payload[0].contents)}}}),Macro.add("branch",{tags:["action","extra","cut"],handler:function(){var t,e=!1,u=State.getVar("$currentScene");if(this.args.length<1||"string"!=typeof this.args[0]||!this.args[0].trim())return this.error("You must name each branch");function l(t,e){return'<<capture _filter>>                            <<run jQuery.wiki("<<set _filter = !!( '.concat(e,' )>>")>>                            <<if _filter>>').concat(t,"<</if>>                       <</capture>>                ")}t=this.args[0].trim(),u.branch&&"start"!==this.args[1]||(u.branch=t,e=!0),u.branches[t]=this.payload.map(function(t){var e,n,a,r,c,i,s,o;switch(t.name){case"branch":e=String(t.contents).trim();break;case"cut":a=String(t.args[0]).trim(),1<t.args.length&&((r=t.args[1]).includes("<<")&&r.includes(">>")?(s=r,2<t.args.length&&(i=t.args[2])):i=r),o=String(t.contents).trim(),n='<<link "'.concat(o,'" "').concat(a,'">>').concat(s,"<<run setup.markCurrentSceneComplete()>><</link>>"),e=i?l(n,i):n;break;case"action":(a=String(t.args[0]).trim()).includes("<<")&&a.includes(">>")||(a='<<set $currentScene.branch to "'.concat(a,'">><<run setup.sceneBranchTaken("').concat(u.name,'","').concat(a,'")>><<run setup.renderCurrentBranch()>>')),r=t.args[1],o=String(t.contents).trim(),n='<<link "'.concat(o,'">>').concat(a,"<</link>>"),e=r?l(n,r):n;break;case"extra":a=String(t.args[0]).trim(),a='<<set $currentScene.branch to "'.concat(a,'">><<run setup.sceneBranchTaken("').concat(u.name,'","').concat(a,'")>><<run setup.renderCurrentBranch()>>'),r=String(t.args[1]).trim(),c=String(t.args[2]).trim(),o=String(t.contents).trim(),n='<<link "'.concat(o,'">>').concat(r).concat(a,"<</link>>"),e=c?l(n,c):n}return e}),e&&setup.renderCurrentBranch()}});