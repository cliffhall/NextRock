"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}!function(){var n=new Map,e=["eunuch","eucalyptus","eugenics","eulogy","euphemism","euphony","euphoria","eureka","european","euphemistic","euphonic","euphoric","euphemistically","euphonically","euphorically","heir","heiress","herb","homage","honesty","honor","honour","hour","honest","honorous","honestly","hourly","one","ouija","once","ubiquitous","ugandan","ukrainian","unanimous","unicameral","unified","unique","unisex","universal","urinal","urological","useful","useless","usurious","usurped","utilitarian","utopic","ubiquitously","unanimously","unicamerally","uniquely","universally","urologically","usefully","uselessly","usuriously"],s=["a","an"],i=/[aeiou8]/i,a=/[A-Z]+$/,o=/[UFHLMNRSX]/,u=/[.,\/#!$%\^&\*;:{}=\-_`~()]/g;function c(t){return"a"===t?"an":"a"}function r(t,r,e){var i;return 0<State.length?(i="cannot add article override -> needs to be run in StoryInit special passage or earlier",console.error(i),i):r&&"string"==typeof r?(t&&"string"==typeof t&&(t=t.toLowerCase().trim()),s.includes(t)?(r=r.trim(),void(e?n.add(r,{article:t,caseSensitive:!!e}):n.add(r.toLowerCase(),{article:t,caseSensitive:!!e}))):(i='cannot add article override -> invalid article, must be "a" or "an"',console.error(i),i)):(i="cannot add article override -> invalid word",console.error(i),i)}function h(t){var r;return r=i.test(t.first())?"an":"a",function(t,r){return!!e.includes(t.toLowerCase())&&c(r)}(t,r)||function(t,r){return!(!a.test(t)||!o.test(t.first()))&&c(r)}(t,r)||r}function l(t){if(t&&"string"==typeof t){var r=t.trim().split(" ")[0].trim();return function(t){var r=(t=t.trim()).toLowerCase();if(n.has(r)||n.has(t)){var e=n.get(r)||n.get(t);return e.caseSensitive&&!n.has(t)?null:e.article}return null}(r=r.replace(u,""))||h(r)}}function f(t,r){if(!t||"string"!=typeof t)return t;var e=l(t);return(r?e.toUpperFirst():e)+" "+t}setup.articles={find:l,output:f,override:r},Macro.add("setarticle",{handler:function(){var t=r(this.args[0],this.args[1],this.args[2]);t&&"string"==typeof t&&this.error(t)}}),Macro.add(["a","an","A","An"],{handler:function(){var t=this.name.first()===this.name.first().toUpperCase();this.output.append(f(String(this.args[0]),t))}})}(),function(){var t="%%cycles",r=!0,e="cycles.pause",i="cycles.pause.menu",n="cycles.postdisplay";function s(){return State.variables[t]}function a(t,r){if(!(this instanceof a))return new a(t,r);if(!t||"object"!==_typeof(t))throw new Error("Cycle() -> invalid definition object");if(!t.name||"string"!=typeof t.name||!t.name.trim())throw new Error("Cycle() -> invalid name");if(this.name=t.name,!t.phases||!Array.isArray(t.phases)||t.phases.length<2)throw new Error("Cycle() -> phases should be an array of at least two strings");if(!t.phases.every(function(t){return t&&"string"==typeof t&&t.trim()}))throw new Error("Cycle() -> each phase should be a valid, non-empty string");this.phases=clone(t.phases),t.period=Number(t.period),(Number.isNaN(t.period)||t.period<1)&&(t.period=1),Number.isInteger(t.period)||(t.period=Math.trunc(t.period)),this.period=t.period,t.increment=Number(t.increment),(Number.isNaN(t.increment)||t.increment<1)&&(t.increment=1),Number.isInteger(t.increment)||(t.increment=Math.trunc(t.increment)),this.increment=t.increment,this.active=void 0===t.active||!!t.active,r=Number(r),(Number.isNaN(r)||r<0)&&(r=0),Number.isInteger(r)||(r=Math.trunc(r)),this.stack=r}State.variables[t]={},Object.assign(a,{is:function(t){return t instanceof a},add:function(t,r){if(!r||"object"!==_typeof(r))throw new Error("Cycle.add() -> invalid definition object");if(t&&"string"==typeof t&&t.trim())r.name=t;else if(!r.name||"string"!=typeof r.name||!r.name.trim())throw new Error("Cycle.add() -> invalid name");var e=new a(r,0);return s()[r.name]=e},has:function(t){var r=s();return r.hasOwnProperty(t)&&a.is(r[t])},get:function(t){return a.has(t)?s()[t]:null},del:function(t){return!!a.has(t)&&(delete s()[t],!0)},clear:function(t){s()},_emit:function(t,r){$(document).trigger({type:":cycle-"+r,cycle:t})},_retrieveCycles:s}),Object.assign(a.prototype,{constructor:a,revive:function(){var r={};return Object.keys(this).forEach(function(t){r[t]=clone(this[t])},this),r},clone:function(){return new a(this.revive(),this.stack)},toJSON:function(){return JSON.reviveWrapper("new setup.Cycle("+JSON.stringify(this.revive())+", "+this.stack+")")},current:function(){return this.phases[Math.trunc(this.stack/this.period)%this.phases.length]},length:function(){return this.period*this.phases.length},turns:function(){return this.period/this.increment},turnsTotal:function(){return this.length()/this.increment},update:function(t){t=Number(t),Number.isNaN(t)&&(t=this.increment);var r=this.current();return this.stack+=t,this.stack<0&&(this.stack=0),Number.isInteger(this.stack)||(this.stack=Math.trunc(this.stack)),r!==this.current()&&a._emit("change"),this},reset:function(){return this.stack=0,a._emit(this,"reset"),this.update(0)},suspend:function(){var t=this.active;return this.active=!1,t!==this.active&&a._emit(this,"suspend"),this},resume:function(){var t=this.active;return this.active=!0,t!==this.active&&a._emit(this,"resume"),this},toggle:function(){return this.active?this.suspend():this.resume(),this},isSuspended:function(){return!this.active},editIncrement:function(t){return t=Number(t),(!Number.isNaN(t)||0<t)&&(Number.isInteger(t)||(t=Math.trunc(t)),this.increment=t),this.increment}}),postdisplay[n]=function(){var t;tags().includes(e)||t?t=!1:tags().includes(i)?t=!0:Object.keys(s()).forEach(function(t){var r=a.get(t);r.active&&r.update()})},setup.Cycle=a,r&&(window.Cycle=window.Cycle||a),Macro.add("newcycle",{tags:["phase"],handler:function(){if(this.args.length<1)return this.error("A cycle must at least be given a name.");if(this.payload.length<2)return this.error("A cycle must be given at least two phases.");var t=this.payload.slice(1).map(function(t){return function(t){if(t.args.length<1)return null;var r=t.args.flatten();return r.every(function(t){return"string"==typeof t})?r:null}(t)}).flatten();if(t.includes(null))return this.error("Each `<<phase>>` tag must be given a valid name.");try{a.add(this.args[0],{phases:t,period:this.args[1],increment:this.args[2],active:this.args[3]&&"string"==typeof this.args[3]&&"suspend"!==this.args[3].trim()})}catch(t){var r=t.message&&t.message.split("->")[1];return r=!!r&&r.trim(),this.error(r||t.message)}}}),Macro.add("editcycle",{handler:function(){if(this.args.length<1||"string"!=typeof this.args[0]||!this.args[0].trim())return this.error("You must name the cycle you wish to act on.");if(this.args.length<2)return this.error("You must provide an action to perform.");var t=a.get(this.args[0]);if(null===t)return this.error('Cannot find a cycle named "'+this.args[0]+'".');if(this.args.includes("suspend")?t.suspend():this.args.includes("toggle")?t.toggle():this.args.includes("resume")&&t.resume(),this.args.includes("increment")){var r=this.args[this.args.indexOf("increment")+1];"number"==typeof r&&t.editIncrement(r)}if(this.args.includesAny("reset","clear")&&t.reset(),this.args.includes("change")){var e=this.args[this.args.indexOf("change")+1];e=Number(e),!Number.isNaN(e)&&Number.isInteger(e)&&t.update(e)}}}),Macro.add("showcycle",{handler:function(){if(this.args.length<1||"string"!=typeof this.args[0]||!this.args[0].trim())return this.error("You must name the cycle you wish to act on.");var t=a.get(this.args[0]);if(null===t)return this.error('Cannot find a cycle named "'+this.args[0]+'".');var r=t.current();this.args.includes("uppercase")?r=r.toUpperCase():this.args.includes("lowercase")?r=r.toLowerCase():this.args.includes("upperfirst")&&(r=r.toUpperFirst()),$(document.createElement("span")).addClass("macro-"+this.name).append(r).appendTo(this.output)}})}(),function(){var l={tryGlobal:!0,defaultStrings:{empty:"The inventory is empty...",listDrop:"Discard",separator:"\n"}};function s(t,r,e,i){$(document).trigger({type:"initialized"===i?":inventory-init":":inventory-update",instance:t,receiving:r,moved:e,context:i})}function a(t){if(t=t?(t=[].slice.call(arguments)).flatten():[],!(this instanceof a))return new a(t);this.inv=t,s(this,null,t=t.length?t:null,"initialized")}Object.assign(a,{is:function(t){return t instanceof a},log:function(t){return a.is(t)?"Inventory.log() -> "+t.toArray().join(" - "):"Inventory.log() -> object is not an inventory..."},removeDuplicates:function(t){if(a.is(t)){var r,e=t.toArray();return r=[],e.forEach(function(t){r.includes(t)||r.push(t)}),r}}}),Object.assign(a.prototype,{transfer:function(t){if(arguments.length<2)return this;if(!a.is(t))return this;for(var r=[].slice.call(arguments),e=[],i=0,n=(r=r.slice(1).flatten()).length;i<n;i++)this.inv.includes(r[i])&&(this.inv.delete(r[i]),e.push(r[i]));return e.length&&(t.inv=t.inv.concat(e),s(this,t,e,"transfer")),this},has:function(){var t=[].slice.call(arguments).flatten();return!(!t||!t.length)&&this.inv.includesAny(t)},hasAll:function(){var t=[].slice.call(arguments).flatten();return!(!t||!t.length)&&this.inv.includesAll(t)},pickUp:function(t){var r,e=[].slice.call(arguments).flatten(),i=this;return e&&e.length&&("unique"!==t&&"unique"!==e[0]||(e=e.splice(1),r=[],e.forEach(function(t){i.inv.includes(t)||r.includes(t)||r.push(t)}),e=r),this.inv=this.inv.concat(e),s(this,null,e,"pickup")),this},drop:function(){var r,t=[].slice.call(arguments).flatten(),e=this;if(t&&t.length){var i=[];t.forEach(function(t){e.has(t)&&(i.push(t),r=e.inv.indexOf(t),e.inv.deleteAt(r))}),s(this,null,i,"drop")}return this},sort:function(){return this.inv=this.inv.sort(),s(this,null,null,"sort"),this},show:function(t){return t&&"string"==typeof t||(t=l.defaultStrings.separator),this.inv.length?this.inv.join(t):l.defaultStrings.empty},empty:function(){var t=clone(this.inv);return this.inv=[],s(this,null,t,"drop"),this},toArray:function(){return this.inv},count:function(r){if(r&&"string"==typeof r){var e=0;return this.toArray().forEach(function(t){t===r&&e++}),e}return this.toArray().length},isEmpty:function(){return 0===this.toArray().length},linkedList:function(o,u){o&&a.is(o)||(o=!1);var t=this.toArray(),c=this,h=$(document.createElement("span"));return t&&t.length?t.forEach(function(t,r,e){var i=$(document.createElement("span")),n=$(document.createElement("a")),s=u||l.defaultStrings.drop,a=function(t,r){var e=Math.random().toString(36).substring(7);return arguments.length<2&&(t=Math.random().toString(36).substring(7),r=random(99)),"simple-inv-"+r+"-"+Date.now()+"-"+t.replace(/[^A-Za-z0-9]/g,"")+"-"+e}(t,r);n.wiki(s).addClass("simple-inv drop-link"),n.ariaClick(function(){o?c.transfer(o,t):c.drop(t),$("#"+a).empty()}),i.attr("id",a).addClass("simple-inv link-listing").wiki(t+" ").append(n),r<e.length-1&&i.wiki("<br />"),h.append(i)}):h.wiki(l.defaultStrings.empty),h},constructor:a,toJSON:function(){return JSON.reviveWrapper("new setup.Inventory("+JSON.stringify(this.inv)+")")},clone:function(){return new a(this.inv)}}),setup.Inventory=a,setup.simpleInv={inventory:a},l.tryGlobal&&(window.Inventory=window.Inventory||a),Macro.add("newinventory",{handler:function(){if(this.args.length<1)return this.error("incorrect number of arguments");var t=this.args[0].trim();if("$"!==t[0]&&"_"!==t[0])return this.error('variable name "'+this.args[0]+'" is missing its sigil ($ or _)');Wikifier.setValue(t,new a(this.args.slice(1).flatten()))}}),Macro.add("pickup",{handler:function(){if(this.args.length<2)return this.error("incorrect number of arguments");var t=this.args[0].trim();if("$"!==t[0]&&"_"!==t[0])return this.error('variable name "'+this.args[0]+'" is missing its sigil ($ or _)');var r=Wikifier.getValue(t);if(!a.is(r))return this.error("variable "+t+" is not an inventory!");r.pickUp(this.args.slice(1).flatten())}}),Macro.add("drop",{handler:function(){if(this.args.length<2)return this.error("incorrect number of arguments");var t=this.args[0].trim();if("$"!==t[0]&&"_"!==t[0])return this.error('variable name "'+this.args[0]+'" is missing its sigil ($ or _)');var r=Wikifier.getValue(t);if(!a.is(r))return this.error("variable "+t+" is not an inventory!");r.drop(this.args.slice(1).flatten())}}),Macro.add("transfer",{handler:function(){if(this.args.length<3)return this.error("incorrect number of arguments");var t=this.args[0].trim();if("$"!==t[0]&&"_"!==t[0])return this.error('variable name "'+this.args[0]+'" is missing its sigil ($ or _)');var r=Wikifier.getValue(t);if(!a.is(r))return this.error("variable "+t+" is not an inventory!");var e=this.args[1].trim();if("$"!==e[0]&&"_"!==e[0])return this.error('variable name "'+this.args[1]+'" is missing its sigil ($ or _)');var i=Wikifier.getValue(e);if(!a.is(i))return this.error("variable "+e+" is not an inventory!");r.transfer(i,this.args.slice(2).flatten())}}),Macro.add("dropall",{handler:function(){if(1!==this.args.length)return this.error("incorrect number of arguments");var t=this.args[0].trim();if("$"!==t[0]&&"_"!==t[0])return this.error('variable name "'+this.args[0]+'" is missing its sigil ($ or _)');var r=Wikifier.getValue(t);if(!a.is(r))return this.error("variable "+t+" is not an inventory!");r.empty()}}),Macro.add("clear","dropall",!1),Macro.add("sort",{handler:function(){if(1!==this.args.length)return this.error("incorrect number of arguments");var t=this.args[0].trim();if("$"!==t[0]&&"_"!==t[0])return this.error('variable name "'+this.args[0]+'" is missing its sigil ($ or _)');var r=Wikifier.getValue(t);if(!a.is(r))return this.error("variable "+t+" is not an inventory!");r.sort()}}),Macro.add("inventory",{handler:function(){if(this.args.length<1||2<this.args.length)return this.error("incorrect number of arguments");var t=this.args[0].trim();if("$"!==t[0]&&"_"!==t[0])return this.error('variable name "'+this.args[0]+'" is missing its sigil ($ or _)');var r=Wikifier.getValue(t);if(!a.is(r))return this.error("variable "+t+" is not an inventory!");var e=$(document.createElement("span")),i=!!this.args[1]&&this.args[1];e.wiki(r.show(i)).addClass("macro-"+this.name).appendTo(this.output)}}),Macro.add("linkedinventory",{handler:function(){if(this.args.length<2||3<this.args.length)return this.error("incorrect number of arguments");var t=!1,r="",e=this.args[1].trim(),i="string"==typeof this.args[0]&&this.args[0];if(!i)return this.error("first argument should be the link text");if("$"!==e[0]&&"_"!==e[0])return this.error('variable name "'+this.args[1]+'" is missing its sigil ($ or _)');var n=Util.slugify(e);n=this.name+"-"+n;var s=Wikifier.getValue(e);if(!a.is(s))return this.error("variable "+e+" is not an inventory!");if(2<this.args.length){if("$"!==(r=this.args[2].trim())[0]&&"_"!==r[0])return this.error('variable name "'+this.args[2]+'" is missing its sigil ($ or _)');if(t=Wikifier.getValue(r),!a.is(t))return this.error("variable "+r+" is not an inventory!")}s.linkedList(t,i).attr({id:n,"data-rec":r,"data-self":e,"data-action":i}).addClass("macro-"+this.name).appendTo(this.output)}})}();